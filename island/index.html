<!DOCTYPE html>
<html lang='en'>

<head>
    <title>Island</title>
    <meta http-equiv="cache-control" content="no-cache, must-revalidate, post-check=0, pre-check=0">
    <meta http-equiv="expires" content="Sat, 31 Oct 2014 00:00:00 GMT">
    <meta http-equiv="pragma" content="no-cache">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://aframe.io/releases/0.3.0/aframe.min.js"></script>
    <script src="./assets/aframe-component-beta.js"></script>
    <script src="./assets/altspace.js"></script>
    <script>
        (function(i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function() {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-89786610-1', 'auto');
        ga('send', 'pageview');
        var mobile = false;
        var audio = "ogg";
        var agent = "desktop";
        if (/AltspaceVR-App build-[0-9a-f]{7} Mobile/.test(navigator.userAgent)) {
            mobile = true;
            agent = "mobile";
            audio = "mp3";
        }
        var timeOfDay = "day"
        var d = new Date();
        var n = d.getUTCHours();
        if (n < 12) {
            timeOfDay = "day";
        }
    </script>
</head>

<body>
    <a-scene altspace='fullspace: true' debug sync-system="author: john-and-jacob; app: island">
        <a-assets timeout="10000">
            <script>
                document.write('<a-asset-item id="sco" src="./assets/' + agent + '/' + timeOfDay + '/island.dae"></a-asset-item>');
            </script>
            <a-asset-item id="sign" src="./assets/sign.dae"></a-asset-item>
            <a-asset-item id="cl" src="./assets/collider.dae"></a-asset-item>
            <script>
                document.write('<a-asset-item id="radio" src="./assets/' + agent + '/' + timeOfDay + '/radio.dae"></a-asset-item>');
            </script>
        </a-assets>

        <a-entity position="0 0 0" collada-model="#sco" id="sco-a" altspace-cursor-collider="enabled: false"></a-entity>
        <a-entity position="0 0 0" collada-model="#radio" id="radio-a" altspace-cursor-collider="enabled: true"></a-entity>

        <script>
            var op = "0.2;";
            if (timeOfDay == "night") {
                op = "0.2";
            }
            //if (!mobile) {
                document.write('<a-entity position="40 1.7 -4.1" opacity="0" n-sound="src: http://island.jacobralph.org/assets/playlist/evening/waves.' + audio + '; volume: 0.6; autoplay: false; loop: true; minDistance: 0.1; maxDistance:15;" altspace-cursor-collider="enabled: true" id="song" color="#004010" soundLoaded></a-entity>');
            //}
            document.write('<a-plane transparent=true material="src: url(./assets/' + agent + '/' + timeOfDay + '/water.jpg); repeat: 150 150;" height="790" width="790" rotation="-90 0 0" position="37.56583 0.40 0.0" opacity="' + op + '" transparent=true altspace-cursor-collider="enabled: false"> <a-animation attribute="position" dur="5000" direction="alternate" easing="ease-in-out-sine" to="37.56583 0.35 0.0" repeat="indefinite"></a-animation> </a-plane>');
        </script>

        <a-entity position="26.81583 2.7 -3.8" width="0.2" height="0.2" depth="0.2" n-object='res: effects/fire'></a-entity>
        <a-entity position="33.13 2.7 -8.81" width="0.2" height="0.2" depth="0.2" n-object='res: effects/fire'></a-entity>
        <a-entity position="19.1 2.7 -4.35" width="0.2" height="0.2" depth="0.2" n-object='res: effects/fire'></a-entity>
        <a-entity position="20.46583 2.7 -10.1" width="0.2" height="0.2" depth="0.2" n-object='res: effects/fire'></a-entity>
        <a-entity position="8.1 2.7 -5.18" width="0.2" height="0.2" depth="0.2" n-object='res: effects/fire'></a-entity>
        <a-entity position="9.61583 3.15 -0.55" width="0.2" height="0.2" depth="0.2" n-object='res: effects/fire'></a-entity>

        <script>
            if (!mobile) {
                document.write('<a-entity position="26.81583 2.7 -3.7" n-sound="src: http://island.jacobralph.org/assets/fire.' + audio + '; autoplay: true; volume: 3; loop: true; minDistance: 0.1; maxDistance: 4; rolloff: cosine" altspace-cursor-collider="enabled: true" id="fire1"></a-entity>');
                document.write('<a-entity position="33.16583 2.7 -8.8" n-sound="src: http://island.jacobralph.org/assets/fire.' + audio + '; autoplay: true; volume: 3; loop: true; minDistance: 0.1; maxDistance: 4; rolloff: cosine" altspace-cursor-collider="enabled: true" id="fire2"></a-entity>');
                document.write('<a-entity position="19.06583 2.7 -4.3" n-sound="src: http://island.jacobralph.org/assets/fire.' + audio + '; autoplay: true; volume: 3; loop: true; minDistance: 0.1; maxDistance: 4; rolloff: cosine" altspace-cursor-collider="enabled: true" id="fire3"></a-entity>');
                document.write('<a-entity position="20.46583 2.7 -10.2" n-sound="src: http://island.jacobralph.org/assets/fire.' + audio + '; autoplay: true; volume: 3; loop: true; minDistance: 0.1; maxDistance: 4; rolloff: cosine" altspace-cursor-collider="enabled: true" id="fire4"></a-entity>');
                document.write('<a-entity position="8.01583 2.7 -5.18" n-sound="src: http://island.jacobralph.org/assets/fire.' + audio + '; autoplay: true; volume: 3; loop: true; minDistance: 0.1; maxDistance: 4; rolloff: cosine" altspace-cursor-collider="enabled: true" id="fire5"></a-entity>');
                document.write('<a-entity position="9.61583 3.15 -0.51" n-sound="src: http://island.jacobralph.org/assets/fire.' + audio + '; autoplay: true; volume: 3; loop: true; minDistance: 0.1; maxDistance: 4; rolloff: cosine" altspace-cursor-collider="enabled: true" id="fire6"></a-entity>');

                document.write('<a-entity id="loop" position="23 1 14" n-sound="src: http://island.jacobralph.org/assets/ocean.' + audio + '; autoplay: true; volume: 0.3; loop: true; minDistance: 0.1; maxDistance: 21; rolloff: cosine" altspace-cursor-collider="enabled: true"></a-entity>');
                document.write('<a-entity id="loop" position="1 1 15" n-sound="src: http://island.jacobralph.org/assets/ocean.' + audio + '; autoplay: true; volume: 0.3; loop: true; minDistance: 0.1; maxDistance: 18; rolloff: cosine" altspace-cursor-collider="enabled: true"></a-entity>');
                document.write('<a-entity id="loop" position="-1 1 -13" n-sound="src: http://island.jacobralph.org/assets/ocean.' + audio + '; autoplay: true; volume: 0.3; loop: true; minDistance: 0.1; maxDistance: 18; rolloff: cosine" altspace-cursor-collider="enabled: true"></a-entity>');
                document.write('<a-entity id="loop" position="21 1 -30" n-sound="src: http://island.jacobralph.org/assets/ocean.' + audio + '; autoplay: true; volume: 0.3; loop: true; minDistance: 0.1; maxDistance: 18; rolloff: cosine" altspace-cursor-collider="enabled: true"></a-entity>');
                document.write('<a-entity id="loop" position="47 1 -27" n-sound="src: http://island.jacobralph.org/assets/ocean.' + audio + '; autoplay: true; volume: 0.3; loop: true; minDistance: 0.1; maxDistance: 18; rolloff: cosine" altspace-cursor-collider="enabled: true"></a-entity>');
                document.write('<a-entity id="loop" position="63 1 -9" n-sound="src: http://island.jacobralph.org/assets/ocean.' + audio + '; autoplay: true; volume: 0.3; loop: true; minDistance: 0.1; maxDistance: 18; rolloff: cosine" altspace-cursor-collider="enabled: true"></a-entity>');
                document.write('<a-entity id="loop" position="60 1 17" n-sound="src: http://island.jacobralph.org/assets/ocean.' + audio + '; autoplay: true; volume: 0.3; loop: true; minDistance: 0.1; maxDistance: 18; rolloff: cosine" altspace-cursor-collider="enabled: true"></a-entity>');
                document.write('<a-entity id="loop" position="39 1 35" n-sound="src: http://island.jacobralph.org/assets/ocean.' + audio + '; autoplay: true; volume: 0.3; loop: true; minDistance: 0.1; maxDistance: 18; rolloff: cosine" altspace-cursor-collider="enabled: true"></a-entity>');
            }
        </script>

        <a-entity position="0 -0.05 0" collada-model="#cl" id="cl-a" altspace-cursor-collider="enabled: false" n-mesh-collider="type: environment; convex: false"></a-entity>

        <a-entity material="color: #004010" scale="0 0 0" id="songSync" sync-transform sync-color></a-entity>

    </a-scene>

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            var fontScale;
            if (mobile) {
                fontScale = 0.85;
            } else {
                fontScale = 1.0;
            }

            function makeSafeFont(g, text, maxWidth) {
                // get pixel width of longest line
                var textWidth = Math.max.apply(null, text.map(function(s) {
                    return g.measureText(s).width;
                }));
                // if longest line is longer than specified max width
                if (textWidth > maxWidth) {
                    // scale down font to bring width down to maxWidth
                    var font = g.font;
                    var fontSize = /[0-9.]+px/.exec(font)[0];
                    var fontSizeValue = parseFloat(fontSize);
                    fontSizeValue = (maxWidth / textWidth) * fontSizeValue;
                    font = font.replace(fontSize, fontSizeValue + 'px');

                    g.font = font;
                }
            }

            function generateTextMaterial(text, options) {
                var texWidth = options.width || 256;
                var fontStack = '"Palatino Linotype", "Book Antiqua", Palatino, serif';

                // set up canvas
                var bmp = document.createElement('canvas');
                var ctx = bmp.getContext('2d');
                bmp.width = texWidth;
                bmp.height = options.height || texWidth;

                ctx.fillStyle = options.backgroundColor;
                ctx.fillRect(0, 0, texWidth, options.height || texWidth);

                // TODO: We can simplify this code if the nameplates had a sane UV mapping
                ctx.font = '' + ((options.fontScale || 0.1) * bmp.height * fontScale) + 'px ' + fontStack;
                makeSafeFont(ctx, [text], 0.9 * texWidth * fontScale);
                ctx.textAlign = 'center';
                if (options.textBaseline) {
                    ctx.textBaseline = options.textBaseline;
                }
                if (options.fillStyle) {
                    ctx.fillStyle = options.fillStyle;
                } else {
                    ctx.fillStyle = 'black';
                }
                if (options.single) {
                    ctx.lineWidth = 5;
                    ctx.strokeText(text, texWidth / 2, bmp.height / 2);
                    ctx.fillText(text, texWidth / 2, bmp.height / 2);
                } else {
                    ctx.fillText(text, texWidth / 2, 35);
                    ctx.fillText(text, texWidth / 2, 86);
                }

                return new THREE.MeshBasicMaterial({
                    map: new THREE.CanvasTexture(bmp)
                });
            }

            function generateColorTextMaterial(text, w, h) {
                var statusMat = generateTextMaterial(text, {
                    backgroundColor: 'transparent',
                    height: 50 * h,
                    width: 256 * w,
                    single: true,
                    fontScale: fontScale,
                    textBaseline: 'middle',
                    fillStyle: 'white'
                });
                statusMat.transparent = true;
                statusMat.side = THREE.DoubleSide;
                return statusMat;
            }

            var sim = altspace.utilities.Simulation();
            var geometry = new THREE.SphereGeometry(1.6, 32, 32);
            var material = new THREE.MeshBasicMaterial({
                color: 0x0077be
            });
            material.side = THREE.DoubleSide;
            var sphere = new THREE.Mesh(geometry, material);
            sphere.position.y = 2.7;
            sim.scene.add(sphere);
            var material1 = generateColorTextMaterial("Hey there! Loading: 0%", 4, 4);
            var plane = new THREE.Mesh(new THREE.PlaneGeometry(0.6, 0.3), material1);
            plane.overdraw = true;
            plane.material.side = THREE.DoubleSide;
            plane.position.y = 2.7;
            plane.position.z = -0.7;
            //plane.rotation.y = 180 * Math.PI / 180;
            sim.scene.add(plane);

            THREE.DefaultLoadingManager.onProgress = function(item, loaded, total) {
                if (total > 15) {
                    var percent = loaded / total;
                    if (percent == 1) {
                        console.log("Loaded");
                        var material_new = generateColorTextMaterial("Hey there! Loading: 60%", 4, 4);
                        plane.material = material_new;
                        plane.needsUpdate = true;
                        setTimeout(function(e) {
                            var material_new = generateColorTextMaterial("Hey there! Loading: 80%", 4, 4);
                            plane.material = material_new;
                            plane.needsUpdate = true;
                        }, 5000);
                        setTimeout(function(e) {
                            sim.scene.remove(sphere);
                            sim.scene.remove(plane);
                        }, 10000);
                    } else {
                        var material_new = generateColorTextMaterial("Hey there! Loading: " + Math.round(percent * 0.5) + "%", 4, 4);
                        plane.material = material_new;
                        plane.needsUpdate = true;
                    }
                }
            };

            setTimeout(function(e) {
                sim.scene.remove(sphere);
                sim.scene.remove(plane);
            }, 60000);

            sim.scene.addEventListener('cursordown', function(data) {
                console.log('Touched Point: X: ' + data.point.x + " Z: " + data.point.z);
            });

            var mesh = document.querySelector('#cl-a');

            mesh.addEventListener('model-loaded', function() {
                setTimeout(function(e) {
                    var meshy = document.querySelector('#cl-a');
                    var object = meshy.object3D;
                    var collider_mesh = object.children[0].children[0].children[0];
                    collider_mesh.material.visible = false;
                }, 500);
            });

            var island = document.querySelector('#sco-a');
            island.addEventListener('model-loaded', function() {
                for (var i = 0; i < this.object3D.children[0].children.length; i++) {
                    var meshy = this.object3D.children[0].children[i];
                    if (meshy.name.indexOf("TSO_Circle") !== -1) {
                        var top = meshy.children[0];
                        top.material.transparent = true;
                        top.material.side = THREE.DoubleSide;
                    } else if (meshy.name.indexOf("TSO_") !== -1) {
                        meshy.children[0].material.transparent = true;
                        meshy.children[0].material.side = THREE.DoubleSide;
                    } 
                }
            });
            var paused = false;
            document.querySelector('#radio-a').addEventListener('click', function () {
                var playing = document.querySelector('#song');
                if(paused){
                    var sync = document.querySelector('#songSync');
                    var songLength = getTimeForColor(sync.getAttribute('material').color);
                    var currentTimeFromEnd = (sync.getAttribute('scale').x * 1000000000) - (Date.now() / 1000);
                    var difference = songLength - currentTimeFromEnd;
                    playing.components['n-sound'].playSound();
                    console.log(difference);
                    playing.components['n-sound'].seek(difference);
                    paused = false;
                } else {
                    playing.components['n-sound'].pauseSound();
                    paused = true;
                }
            });

            //if (!mobile) {
                var songs = [];
                songs.push({
                    color: "#004010",
                    url: "http://island.jacobralph.org/assets/playlist/evening/waves",
                    length: 233
                });
                songs.push({
                    color: "#005e00",
                    url: "http://island.jacobralph.org/assets/playlist/evening/black",
                    length: 230
                });
                songs.push({
                    color: "#005e00",
                    url: "http://island.jacobralph.org/assets/playlist/evening/wise",
                    length: 254
                });
                songs.push({
                    color: "#4e8c23",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/coconut",
                    length: 230
                });
                songs.push({
                    color: "#420666",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/nobody",
                    length: 222
                });
                songs.push({
                    color: "#e29d9d",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/pina",
                    length: 276
                });
                songs.push({
                    color: "#c3f4e5",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/pocket",
                    length: 232
                });
                songs.push({
                    color: "#998b7d",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/riptide",
                    length: 203
                });
                songs.push({
                    color: "#439639",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/river",
                    length: 228
                });
                songs.push({
                    color: "#ff6f1d",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/stolen",
                    length: 313
                });
                songs.push({
                    color: "#ff6f11",
                    url: "http://island.jacobralph.org/assets/playlist/evening/salm-a",
                    length: 305
                });
                songs.push({
                    color: "#ff6f12",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/youth",
                    length: 211
                });
                songs.push({
                    color: "#ff6f13",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/wicked",
                    length: 197
                });
                songs.push({
                    color: "#ff6f14",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/rub",
                    length: 195
                });
                songs.push({
                    color: "#ff6f15",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/love",
                    length: 230
                });
                songs.push({
                    color: "#ff6f16",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/crazy",
                    length: 197
                });
                songs.push({
                    color: "#ff6f17",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/clearly",
                    length: 197
                });
                songs.push({
                    color: "#ff6f18",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/herbs",
                    length: 198
                });
                songs.push({
                    color: "#ff6f19",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/warriors",
                    length: 247
                });
                songs.push({
                    color: "#ff6f20",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/upsetters",
                    length: 198
                });
                songs.push({
                    color: "#ff6f21",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/johnny",
                    length: 224
                });
                songs.push({
                    color: "#ff6f22",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/ragga",
                    length: 259
                });
                songs.push({
                    color: "#ff6f23",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/bad",
                    length: 249
                });
                songs.push({
                    color: "#ff6f24",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/island",
                    length: 223
                });
                songs.push({
                    color: "#ff6f25",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/island",
                    length: 223
                });
                songs.push({
                    color: "#ff6f26",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/boys",
                    length: 216
                });
                songs.push({
                    color: "#ff6f27",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/tropical",
                    length: 138
                });
                songs.push({
                    color: "#ff6f28",
                    url: "http://island.jacobralph.org/assets/playlist/evening/crystal",
                    length: 299
                });
                songs.push({
                    color: "#ff6f29",
                    url: "http://island.jacobralph.org/assets/playlist/evening/dr",
                    length: 161
                });
                songs.push({
                    color: "#ff6f30",
                    url: "http://island.jacobralph.org/assets/playlist/evening/gin",
                    length: 212
                });
                songs.push({
                    color: "#ff6f31",
                    url: "http://island.jacobralph.org/assets/playlist/evening/jammin",
                    length: 200
                });
                songs.push({
                    color: "#ff6f32",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/96",
                    length: 255
                });
                songs.push({
                    color: "#ff6f33",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/you",
                    length: 242
                });
                songs.push({
                    color: "#ff6f34",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/funky",
                    length: 207
                });
                songs.push({
                    color: "#ff6f35",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/better",
                    length: 260
                });
                songs.push({
                    color: "#ff6f36",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/bubble",
                    length: 275
                });
                songs.push({
                    color: "#ff6f38",
                    url: "http://island.jacobralph.org/assets/playlist/afternoon/beach",
                    length: 197
                });
                songs.push({
                    color: "#ff6f39",
                    url: "http://island.jacobralph.org/assets/playlist/evening/loverman",
                    length: 202
                });

                var song = document.querySelector('#song');

                var firstLoad = false;
                song.addEventListener("n-sound-loaded", function(e) {
                    if (firstLoad) {
                        var playing = document.querySelector('#songSync');
                        var currentSong = document.querySelector('#song');
                        var songLength = getTimeForColor(playing.getAttribute('material').color);
                        var currentTimeFromEnd = (playing.getAttribute('scale').x * 1000000000) - (Date.now() / 1000);
                        var difference = songLength - currentTimeFromEnd;
                        console.log("Diff:" + difference);
                        song.setAttribute('n-sound', 'volume', 0.6);
                        paused = false;
                        console.log(difference);
                        song.components['n-sound'].playSound();
                        song.components['n-sound'].seek(difference);
                    }
                    if (!firstLoad) {
                        var playing = document.querySelector('#songSync');
                        if (playing.getAttribute('material').color != getColorForURL(song.getAttribute('n-sound').src)) {
                            song.setAttribute('n-sound', 'src', getURLForColor(playing.getAttribute('material').color) + '.' + audio);
                            paused = false;
                            var songLength = getTimeForColor(playing.getAttribute('material').color);
                            var currentTimeFromEnd = (playing.getAttribute('scale').x * 1000000000) - (Date.now() / 1000);
                            var difference = songLength - currentTimeFromEnd;
                            song.components['n-sound'].playSound();
                            console.log(difference);
                            song.components['n-sound'].seek(difference);
                        }
                        firstLoad = true;
                        setInterval(switchSong, 1000);
                    }
                });

                function getColorForURL(URL) {
                    for (i = 0; i < songs.length; i++) {
                        var object = songs[i];
                        if (URL.indexOf(object.url) !== -1) {
                            return object.color;
                        }
                    }

                    return false;
                }

                function getURLForColor(color) {
                    for (i = 0; i < songs.length; i++) {
                        var object = songs[i];
                        if (object.color === color) {
                            return object.url;
                        }
                    }
                    return false;
                }

                function getTimeForColor(color) {
                    for (i = 0; i < songs.length; i++) {
                        var object = songs[i];
                        if (object.color === color) {
                            return object.length;
                        }
                    }
                    return 0;
                }

                function switchSong() {
                    var currentlyPlaying = document.querySelector('#songSync');
                    var currentSong = document.querySelector('#song');
                    if (currentSong.getAttribute('n-sound').src == getURLForColor(currentlyPlaying.getAttribute('material').color) + "." + audio && currentlyPlaying.getAttribute('scale').x < (Date.now() / 1000000000000) && currentlyPlaying.components['sync'].isMine) {
                        console.log("Yep!");
                        var index = Math.floor(Math.random() * songs.length);
                        var newSong = songs[index];
                        currentSong.setAttribute('n-sound', 'src', newSong.url + "." + audio);
                        currentlyPlaying.setAttribute('material', 'color', newSong.color);
                        currentlyPlaying.setAttribute('scale', (((Date.now() / 1000) + newSong.length) / 1000000000) + " 0 0");
                    } else if (currentSong.getAttribute('n-sound').src != getURLForColor(currentlyPlaying.getAttribute('material').color) + "." + audio) {
                        currentSong.setAttribute('n-sound', 'src', getURLForColor(currentlyPlaying.getAttribute('material').color) + "." + audio);
                    }
                }
            //}

            var loader = new THREE.TextureLoader();
            loader.crossOrigin = '';
            var box = "skydome.jpg";
            if (timeOfDay == "night") {
                box = "NightSky.jpg";
            }
            var texture = THREE.ImageUtils.loadTexture("./assets/" + agent + "/" + timeOfDay + "/" + box);
            var skyGeo = new THREE.SphereGeometry(400, 100, 100);
            var material = new THREE.MeshPhongMaterial({
                map: texture,
            });

            var sky = new THREE.Mesh(skyGeo, material);
            sky.position.x = 37.56583;
            sky.material.side = THREE.BackSide;
            sim.scene.add(sky);

            var lastupdate = "";

            setInterval(function(e) {
                $.ajax({
                    type: "GET",
                    url: "http://island.jacobralph.org/lastupdate.txt",
                    async: true,
                    success: function(text) {
                        if (lastupdate == "") {
                            lastupdate = text;
                        } else {
                            if (lastupdate != text) {
                                location.reload(true);
                            }
                        }
                    }
                });
            }, 5000);

            function hideCollision() {
                var meshymesh = document.querySelector('#cl-a');
                if (meshymesh != undefined && meshymesh.object3d != undefined && meshymesh.object3d.children != undefined && meshymesh.object3d.children.length && meshymesh.object3d.children[0].children != undefined && meshymesh.object3d.children[0].children.length && meshymesh.object3d.children[0].children[0].children != undefined && meshymesh.object3d.children[0].children[0].children.length) {
                    var checkMesh = meshymesh.object3d.children[0].children[0].children[0];
                    if (checkMesh.material.visible) {
                        mesh.material.visible = false;
                    }
                }
            }

            setTimeout(hideCollision, 60000);

            setInterval(function(e) {
                var d = new Date();
                var n = d.getUTCHours();
                if ((n < 12 && timeOfDay != "day") || n > 12 && timeOfDay != "day") {
                    window.location.reload();
                }
            }, 15000);
        });
    </script>
</body>

</html>