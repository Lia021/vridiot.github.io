<!DOCTYPE html>
<html lang='en'>
	<head>
		<title>Island</title>
		<meta http-equiv="cache-control" content="no-cache, must-revalidate, post-check=0, pre-check=0">
		<meta http-equiv="expires" content="Sat, 31 Oct 2014 00:00:00 GMT">
		<meta http-equiv="pragma" content="no-cache">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
		<script src="https://aframe.io/releases/0.3.0/aframe.min.js"></script>
		<script src="./assets/aframe-component.js"></script>
		<script src="./assets/JSNativeComponents.js"></script>
		<script src="./assets/altspace.js"></script>
	</head>

	<body>
		<a-scene altspace ='fullspace: true' debug>
			<a-assets>
				<a-asset-item id="sco" src="./assets/island.dae"></a-asset-item>
				<a-asset-item id="sign" src="./assets/sign.dae"></a-asset-item>
				<a-asset-item id="cl" src="./assets/island.json"></a-asset-item>
			</a-assets>

			<a-entity position="0 0 0" blend-model="#ci" id="ci2" altspace-cursor-collider="enabled: false" n-mesh-collider="type: environment;"></a-entity>
			<a-entity position="0 0 0" collada-model="#sco" id="sco2" collide-mesh altspace-cursor-collider="enabled: false" n-mesh-collider="type: environment;"></a-entity>
			<a-entity position="0 2 0" collada-model="#sign" collide-mesh altspace-cursor-collider="enabled: false"></a-entity>
			<!--<a-box color="tomato" depth="2" height="4" width="0.5" position="1 1 1" n-mesh-collider="type: environment;"></a-box>-->
			<a-plane altspace-cursor-collider="enabled: false" material="src: url(./assets/water10.jpg); repeat: 30 30;" height="130" width="130" rotation="-90 0 0" position="0.0 0.40 0.0" opacity="0.7" transparent=true>
				<a-animation attribute="position" dur="4000" direction="alternate" easing="ease-in-out-sine" to="0.0 0.33 0.0" repeat="indefinite"></a-animation>
			</a-plane>
			<!--<a-plane altspace-cursor-collider="enabled: false" material="src: url(./assets/water10.jpg); repeat: 30 30;" height="100" width="100" rotation="-90 0 0" position="0.25 0.35 0.25" opacity="0.3">
<a-animation attribute="position" dur="4000" direction="alternate" easing="ease-in-out-sine" to="0.5 0.35 0.5" repeat="indefinite"></a-animation>
</a-plane>-->

<!--<a-entity position="0 -54.3 -2" n-sphere-collider="type: environment; radius:55" radius="55" opacity="0"></a-entity>

<a-entity position="7 -54.3 -11" n-sphere-collider="type: environment; radius:55" radius="55" opacity="0"></a-entity>

<a-entity position="10 -54.3 0" n-sphere-collider="type: environment; radius:55" radius="55" opacity="0"></a-entity>

<a-entity position="10 -54.3 10" n-sphere-collider="type: environment; radius:55" radius="55" opacity="0"></a-entity>

<a-entity position="9 -54.3 19" n-sphere-collider="type: environment; radius:55" radius="55" opacity="0"></a-entity>
<!-- --xy -->

<!--<a-entity position="-9 -54.3 -9" n-sphere-collider="type: environment; radius:55" radius="55" opacity="0"></a-entity>

<a-entity position="-9 -54.3 -15" n-sphere-collider="type: environment; radius:55" radius="55" opacity="0"></a-entity>

<a-entity position="1 -54.3 -14" n-sphere-collider="type: environment; radius:55" radius="55" opacity="0"></a-entity>

<a-entity position="-28 -54.3 1" n-sphere-collider="type: environment; radius:55" radius="55" opacity="0"></a-entity>

<a-entity position="-17 -54.3 -7" n-sphere-collider="type: environment; radius:55" radius="55" opacity="0"></a-entity>-->

		</a-scene>
		<script>

			var sim = altspace.utilities.Simulation();

			var loader = new THREE.TextureLoader();
			loader.crossOrigin = '';

			/*var skyBox = new THREE.Object3D();

			//var texture3 = loader.load('./assets/TropicalSunnyDayRight2048.png');
			var texture3 = loader.load('./assets/left.jpg');
			var geometry3 = new THREE.PlaneGeometry(1536, 1536);
			var material3 = new THREE.MeshLambertMaterial( { map: texture3 } );
			material3.side = THREE.DoubleSide;
			material3.setNeedsUpdate = true;
			var skybox1 = new THREE.Mesh( geometry3, material3 );
			skybox1.userData.altspace = {collider: {enabled: false}};
			skybox1.position.y = -368;
			skybox1.position.z = 768;
			skyBox.add(skybox1);

			//var texture4 = loader.load('./assets/TropicalSunnyDayLeft2048.png');
			var texture4 = loader.load('./assets/right.jpg');
			var geometry4 = new THREE.PlaneGeometry(1536, 1536);
			var material4 = new THREE.MeshLambertMaterial( { map: texture4 } );
			material4.side = THREE.DoubleSide;
			material4.setNeedsUpdate = true;
			var skybox2 = new THREE.Mesh( geometry4, material4 );
			skybox2.userData.altspace = {collider: {enabled: false}};
			skybox2.position.y = -368;
			skybox2.position.z = -768;
			skybox2.rotation.set(0, -180 * (Math.PI / 180), 0);
			skyBox.add(skybox2);

			//var texture5 = loader.load('./assets/TropicalSunnyDayFront2048.png');
			var texture5 = loader.load('./assets/front.jpg');
			var geometry5 = new THREE.PlaneGeometry(1536, 1536);
			var material5 = new THREE.MeshLambertMaterial( { map: texture5 } );
			material5.side = THREE.DoubleSide;
			material5.setNeedsUpdate = true;
			var skybox5 = new THREE.Mesh( geometry5, material5 );
			skybox5.userData.altspace = {collider: {enabled: false}};
			skybox5.position.y = -368;
			skybox5.position.x = 768;
			skybox5.rotation.set(0, 90 * (Math.PI / 180), 0);
			skyBox.add(skybox5);

			//var texture6 = loader.load('./assets/TropicalSunnyDayBack2048.png');
			var texture6 = loader.load('./assets/back.jpg');
			var geometry6 = new THREE.PlaneGeometry(1536, 1536);
			var material6 = new THREE.MeshLambertMaterial( { map: texture6 } );
			material6.side = THREE.DoubleSide;
			material6.setNeedsUpdate = true;
			var skybox6 = new THREE.Mesh( geometry6, material6 );
			skybox6.userData.altspace = {collider: {enabled: false}};
			skybox6.position.y = -368;
			skybox6.position.x = -768;
			skybox6.rotation.set(0, -90 * (Math.PI / 180), 0);
			skyBox.add(skybox6);

			//var texture7 = loader.load('./assets/TropicalSunnyDayUp2048.png');
			var texture7 = loader.load('./assets/top.jpg');
			var geometry7 = new THREE.BoxGeometry(1538, 1538, 1538);
			var material7 = new THREE.MeshLambertMaterial( { map: texture7 } );
			material7.side = THREE.DoubleSide;
			material7.setNeedsUpdate = true;
			var skybox7 = new THREE.Mesh( geometry7, material7 );
			skybox7.userData.altspace = {collider: {enabled: false}};
			skybox7.position.y = -378;
			skybox7.rotation.set(-90 * (Math.PI / 180), 0, 90 * (Math.PI / 180));
			skyBox.add(skybox7);
			console.log(skyBox);
			sim.scene.add(skyBox);*/

			var texture = THREE.ImageUtils.loadTexture( "./assets/skydome.png" );
			var skyGeo = new THREE.SphereGeometry(500, 100, 100);
			var material = new THREE.MeshPhongMaterial({
				map: texture,
			});
			var sky = new THREE.Mesh(skyGeo, material);
			sky.position.y = -80;
			sky.rotation.y = -125 * (Math.PI / 180);
			sky.material.side = THREE.BackSide;
			sim.scene.add(sky);

			var tick = 0;
			var forward = false;

			/*function animate() {

				// monitored code goes here
				if(terrain != undefined && terrain != null && terrain2 != undefined && terrain2 != null){
					tick++;
					if(forward){
						if(tick == 180){
							forward = false;
							tick = 0;
						}
						//terrain.position.y = terrain.position.y - 0.0002;
						//terrain.position.z = terrain.position.z - 0.005;
						//terrain2.position.y = terrain2.position.y - 0.0002;
						//terrain2.position.z = terrain2.position.z + 0.005;
					} else {
						if(tick == 180){
							forward = true;
							tick = 0;
						}
						//terrain.position.y = terrain.position.y + 0.0002;
						//terrain.position.z = terrain.position.z + 0.005;
						//terrain2.position.y = terrain2.position.y + 0.0002;
						//terrain2.position.z = terrain2.position.z - 0.005;
					}
				}

				requestAnimationFrame( animate );
			}
			requestAnimationFrame( animate );*/

			var sources = [];
			var skeleton = {};
			sources.push("./assets/ocean.mp3");
			var sound1, sound2;

			var clock = new THREE.Clock();

			var Sound = function ( sources, radius, volume, position) {

				var audio = document.createElement( 'audio' );

				audio.addEventListener('ended', function() {
					this.currentTime = 0;
					this.play();
				}, false);

				for ( var i = 0; i < sources.length; i ++ ) {

					var source = document.createElement( 'source' );
					source.src = sources[ i ];

					audio.appendChild( source );

				}

				this.position = position;

				audio.volume = volume;

				this.play = function () {

					audio.play();

				}

				this.update = function ( p2 ) {

					var distance = this.position.distanceTo( p2 );

					if ( distance <= radius ) {

						audio.volume = volume * ( 1 - distance / radius );

					} else {

						audio.volume = 0;

					}

				}

			}

			var sound = new Sound(sources, 1500, 0.07, new THREE.Vector3(0, -360, 0));

			sound.play();

			var lastupdate = "";

			document.addEventListener('DOMContentLoaded', function(){
			var root = new THREE.Object3D();

			function checkFinishedLoading(){
				var el = document.getElementById("ci2");
				console.log(el.object3DMap);
					var object3D = el.object3D;
					if(object3D.children.length && object3D.children[0].children.length){
						for(var i = 0; i < object3D.children[0].children.length; i++){
							var child = object3D.children[0].children[i];
							for(var d = 0; d < child.children.length; d++){
								var mesh = child.children[d];
					            var testBoxCollider = new NativeComponent('n-mesh-collider', {}, mesh).addTo(root);

							}
						}
					} else {
						setTimeout(checkFinishedLoading, 500);
					}
			}

			checkFinishedLoading();

				setInterval(function(e){
					$.ajax({ type: "GET",
							url: "http://island.jacobralph.org/lastupdate.txt",
							async: true,
							success : function(text)
							{
								console.log(text);
								if(lastupdate == ""){
									lastupdate = text;
								} else {
									if(lastupdate != text){
										location.reload(true);
									}
								}
							}
						   });
				}, 5000);
			});

var geometry2 = new THREE.BoxGeometry(0.15,3.2,4);
var material2 = new THREE.MeshLambertMaterial({color: 0x0000ff, transparent: true, opacity: 0.0});
var box = new THREE.Mesh(geometry2, material2);
box.position.y = 2.5;
box.position.x = 10;

sim.scene.add(box);

var geometry3 = new THREE.BoxGeometry(0.15,3.2,4);
var material3 = new THREE.MeshLambertMaterial({color: 0x0000ff, transparent: true, opacity: 0.0});
var box2 = new THREE.Mesh(geometry3, material3);
box2.position.y = 2.5;
box2.position.x = 10;
box2.rotation.y = -180 * (Math.PI / 180)
sim.scene.add(box2);

var geometry4 = new THREE.BoxGeometry(4,3.2,0.15);
var material4 = new THREE.MeshLambertMaterial({color: 0x0000ff, transparent: true, opacity: 0.0});
var box3 = new THREE.Mesh(geometry4, material4);
box3.position.y = 2.5;
box3.position.x = 10;
box3.rotation.y = -90 * (Math.PI / 180)
sim.scene.add(box3);

var geometry5 = new THREE.BoxGeometry(4,3.2,0.15);
var material5 = new THREE.MeshLambertMaterial({color: 0x0000ff, transparent: true, opacity: 0.0});
var box5 = new THREE.Mesh(geometry5, material5);
box5.position.y = 2.5;
box5.position.x = 10;
box5.rotation.y = 90 * (Math.PI / 180)
sim.scene.add(box5);

		</script>
	</body>
</html>
